<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bệnh Viện  - Hệ thống quản lý</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f0f2f5;
      --card-bg-color: #ffffff;
      --primary-color: #2d6cdf;
      --accent-color: #22a699;
      --text-dark: #1f2937;
      --text-muted: #6b7280;
      --border-color: rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; }
    body { background: var(--bg-color); color: var(--text-dark); font-family: 'Poppins', sans-serif; }
    .container-fluid { padding: 24px; }
    .header-logo { font-size: 2.2rem; font-weight: 700; color: var(--text-dark); display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom: 18px;}
    .header-logo i { color: var(--primary-color); }
    .tab-content { background: var(--card-bg-color); padding: 24px; border-radius: 12px; box-shadow: 0 8px 28px rgba(0,0,0,.08); min-height: 78vh;}
    .nav-tabs { border-bottom: 2px solid var(--border-color); margin-bottom: 18px;}
    .nav-tabs .nav-link { color: var(--text-muted); font-weight: 600; border: none; border-bottom: 3px solid transparent; margin-bottom:-2px; }
    .nav-tabs .nav-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .card { background: var(--card-bg-color); border: 1px solid var(--border-color); }
    .form-control, .form-select { background: #f7f7fb; border: 1px solid var(--border-color); }
    .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 .25rem rgba(45,108,223,.15); }
    .badge-soft { background: #eef2ff; color: #3b82f6; border:1px solid #dbeafe; }
    .btn-primary { background: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { filter: brightness(.95); }
    .btn-success { background: var(--accent-color); border-color: var(--accent-color); }
    .stat-card { border: 0; border-radius: 14px; color: #fff; overflow: hidden; }
    .stat-card .card-body { display:flex; align-items:center; justify-content:space-between; }
    .stat-card i { opacity: .9; }
    .table > :not(caption) > * > * { border-bottom-color: var(--border-color); }
    .room-card { border-radius: 12px; transition: .2s; overflow:hidden; border:1px solid var(--border-color); }
    .room-card:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,.06); }
    .room-card .card-header { display:flex; align-items:center; justify-content:space-between; }
    .room-free { background:#ecfdf5; }
    .room-occupied { background:#fef3c7; }
    .room-maintenance { background:#fee2e2; }
    .status-badge { padding:6px 10px; border-radius:20px; font-weight:700; font-size:.8rem; }
    .status-free { background:#10b981; color:#fff; }
    .status-occupied { background:#f59e0b; color:#fff; }
    .status-maintenance { background:#ef4444; color:#fff; }
    /* Mini chart bars */
    .chart-area { height: 220px; display:flex; align-items:flex-end; gap:18px; }
    .bar { width: 40px; border-radius:6px 6px 0 0; background: var(--primary-color); position:relative; }
    .bar .value { position:absolute; top:-22px; left:50%; transform:translateX(-50%); font-size:.8rem; }
    .bar .label { position:absolute; bottom:-24px; left:50%; transform:translateX(-50%); font-size:.8rem; color:var(--text-muted); }
    .customer-card-item { background: var(--card-bg-color); border:1px solid var(--border-color); border-radius:12px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.04); }
    .customer-card-item:hover { box-shadow:0 10px 22px rgba(0,0,0,.08); }
    .modal-content { background: var(--card-bg-color); }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="text-center header-logo">
    <i class="fa-solid fa-hospital"></i> Bệnh viện 
  </div>

  <!-- TABS -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
        <i class="fa-solid fa-gauge me-2"></i>Tổng quan
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="patient-tab" data-bs-toggle="tab" data-bs-target="#patients" type="button" role="tab">
        <i class="fa-solid fa-bed-pulse me-2"></i>Bệnh nhân
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="doctor-tab" data-bs-toggle="tab" data-bs-target="#doctors" type="button" role="tab">
        <i class="fa-solid fa-user-doctor me-2"></i>Bác sĩ
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="room-tab" data-bs-toggle="tab" data-bs-target="#rooms" type="button" role="tab">
        <i class="fa-solid fa-hospital-user me-2"></i>Phòng bệnh
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="service-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab">
        <i class="fa-solid fa-flask-vial me-2"></i>Dịch vụ
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
        <i class="fa-solid fa-clock-rotate-left me-2"></i>Lịch sử khám
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab">
        <i class="fa-solid fa-chart-line me-2"></i>Thống kê
      </a>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <!-- DASHBOARD -->
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card p-3 shadow-sm">
            <h5 class="card-title text-primary"><i class="fa-solid fa-notes-medical me-2"></i>Tiếp nhận/nhập viện</h5>
            <form id="admitForm">
              <div class="mb-2">
                <label class="form-label">Tên bệnh nhân</label>
                <input type="text" class="form-control" id="admitName" required placeholder="VD: Trần Minh Khoa">
              </div>
              <div class="mb-2">
                <label class="form-label">Số điện thoại</label>
                <input type="tel" class="form-control" id="admitPhone" required placeholder="VD: 0912345678" pattern="^(0?)(3[2-9]|5[6|8|9]|7[0|6-9]|8[0-6|8|9]|9[0-4|6-9])[0-9]{7}$">
                <div class="invalid-feedback">SĐT không hợp lệ.</div>
              </div>
              <div class="mb-2">
                <label class="form-label">Bác sĩ phụ trách</label>
                <select id="admitDoctorId" class="form-select" required></select>
              </div>
              <div class="mb-2">
                <label class="form-label">Chọn phòng/giường</label>
                <select id="admitRoomId" class="form-select" required></select>
              </div>
            </form>
            <h6 class="mt-3 text-primary"><i class="fa-solid fa-flask me-2"></i>Chỉ định dịch vụ</h6>
            <div id="admitServices"></div>
            <hr>
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="startAdmission()"><i class="fa-solid fa-person-circle-plus me-2"></i>Bắt đầu điều trị</button>
              <button class="btn btn-secondary" onclick="resetAdmitForm()"><i class="fa-solid fa-rotate me-2"></i>Đặt lại</button>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0"><i class="fa-solid fa-bed me-2 text-primary"></i>Giường bệnh</h4>
            <select id="sortRooms" class="form-select w-auto" onchange="renderDashboardRooms()">
              <option value="default">Mặc định</option>
              <option value="price_asc">Giá tăng dần</option>
              <option value="price_desc">Giá giảm dần</option>
            </select>
          </div>
          <div id="dashboardRooms" class="row g-3"></div>
        </div>
      </div>
    </div>

    <!-- PATIENTS -->
    <div class="tab-pane fade" id="patients" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Danh sách bệnh nhân</h3>
        <div class="input-group w-50">
          <input type="text" id="patientSearch" class="form-control" placeholder="Tìm theo tên/SĐT..." onkeyup="filterPatients()">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPatientModal"><i class="fa-solid fa-plus me-2"></i>Thêm</button>
        </div>
      </div>
      <div id="patientList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"></div>
    </div>

    <!-- DOCTORS -->
    <div class="tab-pane fade" id="doctors" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Danh sách bác sĩ</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDoctorModal"><i class="fa-solid fa-plus me-2"></i>Thêm</button>
      </div>
      <table class="table table-striped table-hover">
        <thead><tr>
          <th>ID</th><th>Tên</th><th>Chuyên khoa</th><th>Phí khám</th><th>Trạng thái</th><th>Thao tác</th>
        </tr></thead>
        <tbody id="doctorTable"></tbody>
      </table>
    </div>

    <!-- ROOMS -->
    <div class="tab-pane fade" id="rooms" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Danh sách phòng/giường</h3>
        <div>
          <select id="roomFilter" class="form-select d-inline-block w-auto me-2" onchange="filterRoomsTable()">
            <option value="all">Tất cả</option>
            <option value="free">Trống</option>
            <option value="occupied">Đang sử dụng</option>
            <option value="maintenance">Bảo trì</option>
          </select>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoomModal"><i class="fa-solid fa-plus me-2"></i>Thêm</button>
        </div>
      </div>
      <table class="table table-striped table-hover">
        <thead><tr>
          <th>Mã</th><th>Phòng</th><th>Giường</th><th>Loại</th><th>Giá/ngày</th><th>Trạng thái</th><th>Bệnh nhân</th><th>Thời gian bắt đầu</th><th>Thao tác</th>
        </tr></thead>
        <tbody id="roomTable"></tbody>
      </table>
    </div>

    <!-- SERVICES -->
    <div class="tab-pane fade" id="services" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Dịch vụ y tế</h3>
        <div class="input-group w-50">
          <input type="text" id="serviceSearch" class="form-control" placeholder="Tìm dịch vụ..." onkeyup="filterServices()">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal"><i class="fa-solid fa-plus me-2"></i>Thêm</button>
        </div>
      </div>
      <table class="table table-striped table-hover">
        <thead><tr><th>Tên dịch vụ</th><th>Giá</th><th>Trạng thái</th><th>Thao tác</th></tr></thead>
        <tbody id="serviceTable"></tbody>
      </table>
    </div>

    <!-- HISTORY -->
    <div class="tab-pane fade" id="history" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Lịch sử khám & hóa đơn</h3>
        <div class="input-group w-50">
          <input type="date" id="historyDateFilter" class="form-control" onchange="filterHistory()">
          <input type="text" id="historySearch" class="form-control" placeholder="Tìm theo ID/Tên..." onkeyup="filterHistory()">
        </div>
      </div>
      <table class="table table-striped table-hover">
        <thead><tr>
          <th>Mã</th><th>Ngày</th><th>Bệnh nhân</th><th>Bác sĩ</th><th>Phòng</th><th>Tổng tiền</th><th>Chi tiết</th>
        </tr></thead>
        <tbody id="historyTable"></tbody>
      </table>
    </div>

    <!-- STATISTICS -->
    <div class="tab-pane fade" id="statistics" role="tabpanel">
      <h3 class="text-center mb-4"><i class="fa-solid fa-chart-simple me-2"></i>Thống kê hoạt động</h3>
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card stat-card" style="background:#2563eb">
            <div class="card-body">
              <div>
                <div class="h6 mb-1">BN đang điều trị</div>
                <div class="fs-3 fw-bold" id="statPatientsIn">0</div>
              </div>
              <i class="fa-solid fa-bed-pulse fa-2x"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card" style="background:#059669">
            <div class="card-body">
              <div>
                <div class="h6 mb-1">Bác sĩ đang trực</div>
                <div class="fs-3 fw-bold" id="statDoctorsOn">0</div>
              </div>
              <i class="fa-solid fa-user-doctor fa-2x"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card" style="background:#f59e0b">
            <div class="card-body">
              <div>
                <div class="h6 mb-1">Giường trống</div>
                <div class="fs-3 fw-bold" id="statBedsFree">0</div>
              </div>
              <i class="fa-solid fa-hospital-user fa-2x"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card" style="background:#7c3aed">
            <div class="card-body">
              <div>
                <div class="h6 mb-1">Doanh thu</div>
                <div class="fs-3 fw-bold" id="statRevenue">0đ</div>
              </div>
              <i class="fa-solid fa-coins fa-2x"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-body">
          <h5 class="card-title">Doanh thu theo tháng</h5>
          <div id="monthlyRevenueChart" class="chart-area"></div>
        </div>
      </div>
      <div class="card mt-4">
        <div class="card-body">
          <h5 class="card-title">Tỷ trọng doanh thu theo loại phòng</h5>
          <div id="revenueByRoomType" class="chart-area" style="height:180px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<!-- Add Patient -->
<div class="modal fade" id="addPatientModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Thêm bệnh nhân</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="newPatientForm" onsubmit="addPatient(event)">
        <div class="mb-2">
          <label class="form-label">Họ tên</label>
          <input type="text" class="form-control" id="newPatientName" required>
        </div>
        <div class="mb-2">
          <label class="form-label">SĐT</label>
          <input type="tel" class="form-control" id="newPatientPhone" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Ngày sinh</label>
          <input type="date" class="form-control" id="newPatientDob">
        </div>
        <div class="mb-2">
          <label class="form-label">Giới tính</label>
          <select id="newPatientGender" class="form-select">
            <option value="Nam">Nam</option>
            <option value="Nữ">Nữ</option>
            <option value="Khác">Khác</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Edit Patient -->
<div class="modal fade" id="editPatientModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Sửa bệnh nhân</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="editPatientForm" onsubmit="updatePatient(event)">
        <input type="hidden" id="editPatientId">
        <div class="mb-2"><label class="form-label">Họ tên</label>
          <input type="text" class="form-control" id="editPatientName" required></div>
        <div class="mb-2"><label class="form-label">SĐT</label>
          <input type="tel" class="form-control" id="editPatientPhone" required></div>
        <div class="mb-2"><label class="form-label">Ngày sinh</label>
          <input type="date" class="form-control" id="editPatientDob"></div>
        <div class="mb-2"><label class="form-label">Giới tính</label>
          <select id="editPatientGender" class="form-select">
            <option value="Nam">Nam</option>
            <option value="Nữ">Nữ</option>
            <option value="Khác">Khác</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Cập nhật</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Add Doctor -->
<div class="modal fade" id="addDoctorModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Thêm bác sĩ</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="newDoctorForm" onsubmit="addDoctor(event)">
        <div class="mb-2"><label class="form-label">Họ tên</label>
          <input type="text" class="form-control" id="newDoctorName" required></div>
        <div class="mb-2"><label class="form-label">Chuyên khoa</label>
          <input type="text" class="form-control" id="newDoctorDept" required></div>
        <div class="mb-2"><label class="form-label">Phí khám (đ)</label>
          <input type="number" class="form-control" id="newDoctorFee" min="0" value="150000" required></div>
        <div class="mb-2"><label class="form-label">Trạng thái</label>
          <select id="newDoctorStatus" class="form-select">
            <option value="on">Đang trực</option>
            <option value="off">Ngoài ca</option>
          </select></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Edit Doctor -->
<div class="modal fade" id="editDoctorModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Sửa bác sĩ</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="editDoctorForm" onsubmit="updateDoctor(event)">
        <input type="hidden" id="editDoctorId">
        <div class="mb-2"><label class="form-label">Họ tên</label>
          <input type="text" class="form-control" id="editDoctorName" required></div>
        <div class="mb-2"><label class="form-label">Chuyên khoa</label>
          <input type="text" class="form-control" id="editDoctorDept" required></div>
        <div class="mb-2"><label class="form-label">Phí khám (đ)</label>
          <input type="number" class="form-control" id="editDoctorFee" min="0" required></div>
        <div class="mb-2"><label class="form-label">Trạng thái</label>
          <select id="editDoctorStatus" class="form-select">
            <option value="on">Đang trực</option>
            <option value="off">Ngoài ca</option>
          </select></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Cập nhật</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Add Room -->
<div class="modal fade" id="addRoomModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Thêm phòng/giường</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="newRoomForm" onsubmit="addRoom(event)">
        <div class="mb-2"><label class="form-label">Phòng</label>
          <input type="text" class="form-control" id="newRoomName" placeholder="A101" required></div>
        <div class="mb-2"><label class="form-label">Mã giường</label>
          <input type="text" class="form-control" id="newBedCode" placeholder="G1" required></div>
        <div class="mb-2"><label class="form-label">Loại</label>
          <select id="newRoomType" class="form-select">
            <option value="standard">Thường</option>
            <option value="vip">VIP</option>
          </select></div>
        <div class="mb-2"><label class="form-label">Giá/ngày</label>
          <input type="number" class="form-control" id="newRoomPrice" min="0" value="350000" required></div>
        <div class="mb-2"><label class="form-label">Trạng thái</label>
          <select id="newRoomStatus" class="form-select">
            <option value="free">Trống</option>
            <option value="occupied">Đang sử dụng</option>
            <option value="maintenance">Bảo trì</option>
          </select></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Edit Room -->
<div class="modal fade" id="editRoomModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Sửa phòng/giường</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="editRoomForm" onsubmit="updateRoom(event)">
        <input type="hidden" id="editRoomId">
        <div class="mb-2"><label class="form-label">Phòng</label>
          <input type="text" class="form-control" id="editRoomName" required></div>
        <div class="mb-2"><label class="form-label">Mã giường</label>
          <input type="text" class="form-control" id="editBedCode" required></div>
        <div class="mb-2"><label class="form-label">Loại</label>
          <select id="editRoomType" class="form-select">
            <option value="standard">Thường</option>
            <option value="vip">VIP</option>
          </select></div>
        <div class="mb-2"><label class="form-label">Giá/ngày</label>
          <input type="number" class="form-control" id="editRoomPrice" min="0" required></div>
        <div class="mb-2"><label class="form-label">Trạng thái</label>
          <select id="editRoomStatus" class="form-select">
            <option value="free">Trống</option>
            <option value="occupied">Đang sử dụng</option>
            <option value="maintenance">Bảo trì</option>
          </select></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Cập nhật</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Add Service -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Thêm dịch vụ</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="newServiceForm" onsubmit="addService(event)">
        <div class="mb-2"><label class="form-label">Tên dịch vụ</label>
          <input type="text" class="form-control" id="newServiceName" required></div>
        <div class="mb-2"><label class="form-label">Giá</label>
          <input type="number" class="form-control" id="newServicePrice" min="0" required></div>
        <div class="mb-2"><label class="form-label">Trạng thái</label>
          <select id="newServiceStatus" class="form-select">
            <option value="active">Hoạt động</option>
            <option value="inactive">Tạm ngưng</option>
          </select></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Edit Service -->
<div class="modal fade" id="editServiceModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Sửa dịch vụ</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="editServiceForm" onsubmit="updateService(event)">
        <input type="hidden" id="editServiceId">
        <div class="mb-2"><label class="form-label">Tên dịch vụ</label>
          <input type="text" class="form-control" id="editServiceName" required></div>
        <div class="mb-2"><label class="form-label">Giá</label>
          <input type="number" class="form-control" id="editServicePrice" required></div>
        <div class="mb-2"><label class="form-label">Trạng thái</label>
          <select id="editServiceStatus" class="form-select">
            <option value="active">Hoạt động</option>
            <option value="inactive">Tạm ngưng</option>
          </select></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Cập nhật</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- Payment/Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Thanh toán & Hóa đơn</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body" id="invoiceBody"></div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ====== MOCK DATA ======
let patients = [
  { id: 201, name: "Nguyễn Văn A", phone: "0912345678", dob: "1989-04-12", gender: "Nam" },
  { id: 202, name: "Trần Thị B", phone: "0981112233", dob: "1995-10-05", gender: "Nữ" }
];
let doctors = [
  { id: 301, name: "BS. Lê Minh", dept: "Nội tổng quát", fee: 150000, status: "on" },
  { id: 302, name: "BS. Phạm An", dept: "Ngoại khoa", fee: 200000, status: "off" },
  { id: 303, name: "BS. Đặng Vy", dept: "Nhi khoa", fee: 180000, status: "on" }
];
let services = [
  { id: 1, name: "Khám tổng quát", price: 120000, status: "active" },
  { id: 2, name: "Xét nghiệm máu", price: 180000, status: "active" },
  { id: 3, name: "Chụp X-quang", price: 250000, status: "active" },
  { id: 4, name: "Siêu âm", price: 220000, status: "inactive" }
];
let rooms = [
  { id: 1, room: "A101", bed: "G1", type: "standard", price: 350000, status: "free", patientId: null, doctorId: null, startTime: null },
  { id: 2, room: "A101", bed: "G2", type: "standard", price: 350000, status: "occupied", patientId: 201, doctorId: 301, startTime: Date.now() - 36e5 * 10 },
  { id: 3, room: "VIP01", bed: "G1", type: "vip", price: 700000, status: "maintenance", patientId: null, doctorId: null, startTime: null },
  { id: 4, room: "B203", bed: "G1", type: "standard", price: 350000, status: "free", patientId: null, doctorId: null, startTime: null }
];
let history = [
  {
    id: 1,
    date: "2025-08-14",
    patientName: "Nguyễn Văn A",
    doctorName: "BS. Lê Minh",
    roomName: "A101/G2",
    totalAmount: 650000,
    details: {
      days: 1,
      roomCost: 350000,
      doctorFee: 150000,
      services: [{ name: "Khám tổng quát", quantity: 1, price: 120000 }, { name: "Xét nghiệm máu", quantity: 1, price: 180000 }]
    }
  }
];

// ====== HELPERS ======
const formatCurrency = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n || 0);
const getDoctor = id => doctors.find(d => d.id == id);
const getPatient = id => patients.find(p => p.id == id);
const roomTypeText = t => t === 'vip' ? 'VIP' : 'Thường';
const roomStatusText = s => s==='free'?'Trống':(s==='occupied'?'Đang sử dụng':'Bảo trì');
const statusBadgeClass = s => s==='free'?'status-free':(s==='occupied'?'status-occupied':'status-maintenance');

// ====== DASHBOARD RENDER ======
function renderAdmitSelects(){
  const dSel = document.getElementById('admitDoctorId');
  const rSel = document.getElementById('admitRoomId');
  dSel.innerHTML = '<option value="">-- Chọn bác sĩ --</option>' + doctors.map(d => `<option value="${d.id}" ${d.status==='off'?'disabled':''}>${d.name} - ${d.dept} (${formatCurrency(d.fee)}) ${d.status==='off'?'[Ngoài ca]':''}</option>`).join('');
  const freeRooms = rooms.filter(r => r.status === 'free');
  rSel.innerHTML = '<option value="">-- Chọn phòng/giường --</option>' + freeRooms.sort((a,b)=> a.type===b.type ? a.price-b.price : (a.type==='vip'?-1:1)).map(r => `<option value="${r.id}">${r.room}/${r.bed} (${roomTypeText(r.type)}) - ${formatCurrency(r.price)}/ngày</option>`).join('');
}
function renderAdmitServices(){
  const wrap = document.getElementById('admitServices');
  wrap.innerHTML = services.filter(s => s.status==='active').map(s => `
    <div class="d-flex align-items-center mb-2">
      <input type="number" class="form-control me-2" value="0" min="0" data-service-id="${s.id}">
      <span>${s.name} (${formatCurrency(s.price)})</span>
    </div>
  `).join('');
}

function renderDashboardRooms(){
  const container = document.getElementById('dashboardRooms');
  container.innerHTML='';
  const sortOpt = document.getElementById('sortRooms').value;
  const sorted = [...rooms];
  if(sortOpt==='price_asc') sorted.sort((a,b)=>a.price-b.price);
  if(sortOpt==='price_desc') sorted.sort((a,b)=>b.price-a.price);

  sorted.forEach(r => {
    const pat = r.patientId ? getPatient(r.patientId) : null;
    const doc = r.doctorId ? getDoctor(r.doctorId) : null;
    const headerClass = r.status==='free'?'room-free':(r.status==='occupied'?'room-occupied':'room-maintenance');
    const timer = r.startTime ? `<p class="mb-1"><i class="fa-regular fa-clock me-1"></i><span id="timer-${r.id}">--:--:--</span></p>` : '';
    const actionBtn = r.status==='occupied'
      ? `<button class="btn btn-danger btn-sm" onclick="discharge(${r.id})"><i class="fa-solid fa-person-walking-dashed-line-arrow-right"></i> Xuất viện</button>`
      : `<button class="btn btn-primary btn-sm" onclick="selectRoomForAdmit(${r.id})" ${r.status!=='free'?'disabled':''}><i class="fa-solid fa-person-circle-plus"></i> Nhập viện</button>`;
    container.innerHTML += `
      <div class="col-sm-6 col-md-4 col-lg-3">
        <div class="card room-card">
          <div class="card-header ${headerClass}">
            <span><strong>${r.room}/${r.bed}</strong> • ${roomTypeText(r.type)}</span>
            <span class="status-badge ${statusBadgeClass(r.status)}">${roomStatusText(r.status)}</span>
          </div>
          <div class="card-body">
            ${pat?`<p class="mb-1"><i class="fa-solid fa-user me-1"></i>${pat.name}</p>`:''}
            ${doc?`<p class="mb-1"><i class="fa-solid fa-user-doctor me-1"></i>${doc.name}</p>`:''}
            ${timer}
            <div class="d-flex justify-content-between align-items-center mt-2">
              <span class="fw-bold text-primary">${formatCurrency(r.price)}/ngày</span>
              ${actionBtn}
            </div>
          </div>
        </div>
      </div>`;
  });
  updateRoomTimers();
  renderAdmitSelects(); // refresh free rooms
}

function updateRoomTimers(){
  rooms.forEach(r => {
    if(r.status==='occupied' && r.startTime){
      const el = document.getElementById(`timer-${r.id}`);
      if(el){
        if(r._interval) clearInterval(r._interval);
        r._interval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - r.startTime)/1000);
          const h = Math.floor(elapsed/3600);
          const m = Math.floor((elapsed%3600)/60);
          const s = elapsed%60;
          el.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }, 1000);
      }
    } else if(r._interval){
      clearInterval(r._interval);
    }
  });
}

function selectRoomForAdmit(id){
  document.getElementById('admitRoomId').value = id;
}

function startAdmission(){
  const name = document.getElementById('admitName').value.trim();
  const phone = document.getElementById('admitPhone').value.trim();
  const doctorId = parseInt(document.getElementById('admitDoctorId').value);
  const roomId = parseInt(document.getElementById('admitRoomId').value);
  if(!name || !phone || !doctorId || !roomId){
    alert('Vui lòng điền đầy đủ thông tin!');
    return;
  }
  // Create or reuse patient (simple: always create new id)
  const newPatient = { id: Date.now(), name, phone, dob:'', gender:'Khác' };
  patients.push(newPatient);
  // Attach to room
  const room = rooms.find(r => r.id===roomId);
  room.status = 'occupied';
  room.patientId = newPatient.id;
  room.doctorId = doctorId;
  room.startTime = Date.now();

  // Collect selected services
  const serviceInputs = Array.from(document.querySelectorAll('#admitServices input[type=number]'));
  const orderedServices = serviceInputs.map(inp => ({ id: parseInt(inp.dataset.serviceId), qty: parseInt(inp.value)||0 })).filter(x=>x.qty>0);

  room._orderedServices = orderedServices; // keep simple association for this admission

  renderDashboardRooms();
  renderRoomsTable();
  renderPatients();
  resetAdmitForm();
}

function resetAdmitForm(){ document.getElementById('admitForm').reset(); }

function discharge(roomId){
  const room = rooms.find(r=>r.id===roomId);
  if(!room || room.status!=='occupied') return;
  const pat = getPatient(room.patientId);
  const doc = getDoctor(room.doctorId);
  const start = room.startTime;
  const now = Date.now();
  const msPerDay = 24*3600*1000;
  const days = Math.max(1, Math.ceil((now - start)/msPerDay)); // làm tròn lên theo ngày, tối thiểu 1
  const roomCost = days * room.price;
  const doctorFee = doc ? doc.fee : 0;
  const serviceCost = (room._orderedServices||[]).reduce((sum, s) => {
    const svc = services.find(x=>x.id===s.id);
    return sum + (svc ? svc.price * s.qty : 0);
  }, 0);
  const total = roomCost + doctorFee + serviceCost;

  // Build invoice modal
  const body = document.getElementById('invoiceBody');
  body.innerHTML = `
    <h5>Hóa đơn thanh toán</h5><hr>
    <p><strong>Bệnh nhân:</strong> ${pat?pat.name:'---'}</p>
    <p><strong>Bác sĩ:</strong> ${doc?doc.name:'---'} (${doc?doc.dept:'---'})</p>
    <p><strong>Phòng/Giường:</strong> ${room.room}/${room.bed} (${roomTypeText(room.type)})</p>
    <p><strong>Thời gian điều trị:</strong> ${days} ngày</p>
    <hr>
    <p><strong>Tiền phòng:</strong> ${formatCurrency(roomCost)}</p>
    <p><strong>Phí bác sĩ:</strong> ${formatCurrency(doctorFee)}</p>
    <div><strong>Dịch vụ:</strong>
      <ul>
        ${(room._orderedServices||[]).map(s=>{
          const svc = services.find(x=>x.id===s.id);
          return `<li>${svc?svc.name:'Dịch vụ'} x ${s.qty} (${formatCurrency(svc?svc.price:0)})</li>`;
        }).join('') || '<li>Không</li>'}
      </ul>
    </div>
    <h4 class="text-end">Tổng cộng: <span class="text-primary" id="invoiceTotal">${formatCurrency(total)}</span></h4>
    <div class="mb-3">
      <label class="form-label">Tiền khách đưa</label>
      <input type="number" class="form-control" id="paidAmount" value="${total}" oninput="calcChange()">
    </div>
    <h5 class="text-end">Tiền thừa: <span id="changeAmount" class="text-success">${formatCurrency(0)}</span></h5>
    <div class="d-flex justify-content-end">
      <button class="btn btn-success me-2" onclick="confirmPayment(${room.id}, ${days}, ${roomCost}, ${doctorFee})">Thanh toán</button>
      <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
    </div>
  `;
  const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
  modal.show();
}

function calcChange(){
  const total = parseInt(document.getElementById('invoiceTotal').textContent.replace(/[^0-9]/g,''))||0;
  const paid = parseInt(document.getElementById('paidAmount').value)||0;
  const change = Math.max(0, paid-total);
  document.getElementById('changeAmount').textContent = formatCurrency(change);
}

function confirmPayment(roomId, days, roomCost, doctorFee){
  const room = rooms.find(r=>r.id===roomId);
  const pat = getPatient(room.patientId);
  const doc = getDoctor(room.doctorId);
  const servicesList = (room._orderedServices||[]).map(s => {
    const svc = services.find(x=>x.id===s.id);
    return { name: svc?svc.name:'Dịch vụ', quantity: s.qty, price: svc?svc.price:0 };
  });
  const total = roomCost + doctorFee + servicesList.reduce((sum,s)=>sum + s.price*s.quantity,0);
  // push history
  history.push({
    id: Date.now(),
    date: new Date().toISOString().slice(0,10),
    patientName: pat?pat.name:'---',
    doctorName: doc?doc.name:'---',
    roomName: `${room.room}/${room.bed}`,
    totalAmount: total,
    details: { days, roomCost, doctorFee, services: servicesList }
  });
  alert('Thanh toán thành công!');
  // reset room
  room.status='free'; room.patientId=null; room.doctorId=null; room.startTime=null; room._orderedServices=[];
  // refresh UI
  renderDashboardRooms(); renderRoomsTable(); renderStatistics(); renderHistoryTable();
  // close modal
  bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
}

// ====== PATIENTS ======
function renderPatients(){
  const wrap = document.getElementById('patientList');
  wrap.innerHTML='';
  patients.forEach(p => {
    wrap.innerHTML += `
      <div class="col">
        <div class="customer-card-item">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">${p.name}</h5>
            <span class="badge badge-soft">ID: ${p.id}</span>
          </div>
          <div class="mb-1"><i class="fa-solid fa-phone me-2 text-primary"></i>${p.phone||'---'}</div>
          <div class="mb-1"><i class="fa-regular fa-calendar me-2 text-primary"></i>${p.dob||'---'}</div>
          <div class="mb-2"><i class="fa-solid fa-venus-mars me-2 text-primary"></i>${p.gender||'---'}</div>
          <div class="d-flex gap-2">
            <button class="btn btn-warning btn-sm" onclick="showEditPatient(${p.id})">Sửa</button>
            <button class="btn btn-danger btn-sm" onclick="deletePatient(${p.id})">Xóa</button>
          </div>
        </div>
      </div>`;
  });
}
function addPatient(e){
  e.preventDefault();
  const name = document.getElementById('newPatientName').value;
  const phone = document.getElementById('newPatientPhone').value;
  const dob = document.getElementById('newPatientDob').value;
  const gender = document.getElementById('newPatientGender').value;
  patients.push({ id: Date.now(), name, phone, dob, gender });
  renderPatients();
  bootstrap.Modal.getInstance(document.getElementById('addPatientModal')).hide();
  document.getElementById('newPatientForm').reset();
}
function showEditPatient(id){
  const p = patients.find(x=>x.id==id); if(!p) return;
  document.getElementById('editPatientId').value = p.id;
  document.getElementById('editPatientName').value = p.name;
  document.getElementById('editPatientPhone').value = p.phone||'';
  document.getElementById('editPatientDob').value = p.dob||'';
  document.getElementById('editPatientGender').value = p.gender||'Khác';
  new bootstrap.Modal(document.getElementById('editPatientModal')).show();
}
function updatePatient(e){
  e.preventDefault();
  const id = parseInt(document.getElementById('editPatientId').value);
  const name = document.getElementById('editPatientName').value;
  const phone = document.getElementById('editPatientPhone').value;
  const dob = document.getElementById('editPatientDob').value;
  const gender = document.getElementById('editPatientGender').value;
  const idx = patients.findIndex(p=>p.id==id);
  if(idx>-1) patients[idx] = { id, name, phone, dob, gender };
  renderPatients();
  bootstrap.Modal.getInstance(document.getElementById('editPatientModal')).hide();
}
function deletePatient(id){
  if(confirm('Xóa bệnh nhân này?')){
    patients = patients.filter(p=>p.id!==id);
    renderPatients();
  }
}
function filterPatients(){
  const q = document.getElementById('patientSearch').value.toLowerCase();
  Array.from(document.querySelectorAll('#patientList .col')).forEach(col => {
    const text = col.textContent.toLowerCase();
    col.style.display = text.includes(q) ? '' : 'none';
  });
}

// ====== DOCTORS ======
function renderDoctors(){
  const tb = document.getElementById('doctorTable'); tb.innerHTML='';
  doctors.forEach(d => {
    tb.innerHTML += `
      <tr>
        <td>${d.id}</td>
        <td>${d.name}</td>
        <td>${d.dept}</td>
        <td>${formatCurrency(d.fee)}</td>
        <td><span class="badge ${d.status==='on'?'bg-success':'bg-secondary'}">${d.status==='on'?'Đang trực':'Ngoài ca'}</span></td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="showEditDoctor(${d.id})">Sửa</button>
          <button class="btn btn-danger btn-sm" onclick="deleteDoctor(${d.id})">Xóa</button>
        </td>
      </tr>`;
  });
}
function addDoctor(e){
  e.preventDefault();
  const name = document.getElementById('newDoctorName').value;
  const dept = document.getElementById('newDoctorDept').value;
  const fee = parseFloat(document.getElementById('newDoctorFee').value)||0;
  const status = document.getElementById('newDoctorStatus').value;
  doctors.push({ id: Date.now(), name, dept, fee, status });
  renderDoctors(); renderAdmitSelects();
  bootstrap.Modal.getInstance(document.getElementById('addDoctorModal')).hide();
  document.getElementById('newDoctorForm').reset();
}
function showEditDoctor(id){
  const d = doctors.find(x=>x.id==id); if(!d) return;
  document.getElementById('editDoctorId').value = d.id;
  document.getElementById('editDoctorName').value = d.name;
  document.getElementById('editDoctorDept').value = d.dept;
  document.getElementById('editDoctorFee').value = d.fee;
  document.getElementById('editDoctorStatus').value = d.status;
  new bootstrap.Modal(document.getElementById('editDoctorModal')).show();
}
function updateDoctor(e){
  e.preventDefault();
  const id = parseInt(document.getElementById('editDoctorId').value);
  const name = document.getElementById('editDoctorName').value;
  const dept = document.getElementById('editDoctorDept').value;
  const fee = parseFloat(document.getElementById('editDoctorFee').value);
  const status = document.getElementById('editDoctorStatus').value;
  const idx = doctors.findIndex(d=>d.id==id);
  if(idx>-1) doctors[idx] = { id, name, dept, fee, status };
  renderDoctors(); renderAdmitSelects();
  bootstrap.Modal.getInstance(document.getElementById('editDoctorModal')).hide();
}
function deleteDoctor(id){
  if(confirm('Xóa bác sĩ này?')){
    doctors = doctors.filter(d=>d.id!==id);
    renderDoctors(); renderAdmitSelects();
  }
}

// ====== ROOMS ======
function renderRoomsTable(){
  const tb = document.getElementById('roomTable'); tb.innerHTML='';
  rooms.forEach(r => {
    const pName = r.patientId ? (getPatient(r.patientId)?.name || '---') : 'N/A';
    const start = r.startTime ? new Date(r.startTime).toLocaleString('vi-VN') : 'N/A';
    tb.innerHTML += `
      <tr>
        <td>${r.id}</td>
        <td>${r.room}</td>
        <td>${r.bed}</td>
        <td>${roomTypeText(r.type)}</td>
        <td>${formatCurrency(r.price)}</td>
        <td><span class="badge ${r.status==='free'?'bg-success':(r.status==='occupied'?'bg-warning text-dark':'bg-danger')}">${roomStatusText(r.status)}</span></td>
        <td>${pName}</td>
        <td>${start}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="showEditRoom(${r.id})">Sửa</button>
          <button class="btn btn-danger btn-sm" onclick="deleteRoom(${r.id})">Xóa</button>
        </td>
      </tr>`;
  });
}
function showEditRoom(id){
  const r = rooms.find(x=>x.id==id); if(!r) return;
  document.getElementById('editRoomId').value = r.id;
  document.getElementById('editRoomName').value = r.room;
  document.getElementById('editBedCode').value = r.bed;
  document.getElementById('editRoomType').value = r.type;
  document.getElementById('editRoomPrice').value = r.price;
  document.getElementById('editRoomStatus').value = r.status;
  new bootstrap.Modal(document.getElementById('editRoomModal')).show();
}
function updateRoom(e){
  e.preventDefault();
  const id = parseInt(document.getElementById('editRoomId').value);
  const roomName = document.getElementById('editRoomName').value;
  const bed = document.getElementById('editBedCode').value;
  const type = document.getElementById('editRoomType').value;
  const price = parseFloat(document.getElementById('editRoomPrice').value);
  const status = document.getElementById('editRoomStatus').value;
  const idx = rooms.findIndex(r=>r.id==id);
  if(idx>-1) rooms[idx] = { ...rooms[idx], room: roomName, bed, type, price, status };
  renderRoomsTable(); renderDashboardRooms();
  bootstrap.Modal.getInstance(document.getElementById('editRoomModal')).hide();
}
function addRoom(e){
  e.preventDefault();
  const roomName = document.getElementById('newRoomName').value;
  const bed = document.getElementById('newBedCode').value;
  const type = document.getElementById('newRoomType').value;
  const price = parseFloat(document.getElementById('newRoomPrice').value);
  const status = document.getElementById('newRoomStatus').value;
  rooms.push({ id: Date.now(), room: roomName, bed, type, price, status, patientId:null, doctorId:null, startTime:null });
  renderRoomsTable(); renderDashboardRooms();
  bootstrap.Modal.getInstance(document.getElementById('addRoomModal')).hide();
  document.getElementById('newRoomForm').reset();
}
function deleteRoom(id){
  if(confirm('Xóa phòng/giường này?')){
    rooms = rooms.filter(r=>r.id!==id);
    renderRoomsTable(); renderDashboardRooms();
  }
}
function filterRoomsTable(){
  const v = document.getElementById('roomFilter').value;
  Array.from(document.querySelectorAll('#roomTable tr')).forEach(tr => {
    const text = tr.textContent;
    if(v==='all') tr.style.display='';
    else tr.style.display = text.includes(v==='free'?'Trống':(v==='occupied'?'Đang sử dụng':'Bảo trì')) ? '' : 'none';
  });
}

// ====== SERVICES ======
function renderServices(){
  const tb = document.getElementById('serviceTable'); tb.innerHTML='';
  services.forEach(s => {
    tb.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${formatCurrency(s.price)}</td>
        <td><span class="badge ${s.status==='active'?'bg-success':'bg-secondary'}">${s.status==='active'?'Hoạt động':'Tạm ngưng'}</span></td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="showEditService(${s.id})">Sửa</button>
          <button class="btn btn-danger btn-sm" onclick="deleteService(${s.id})">Xóa</button>
        </td>
      </tr>`;
  });
  renderAdmitServices();
}
function addService(e){
  e.preventDefault();
  const name = document.getElementById('newServiceName').value;
  const price = parseFloat(document.getElementById('newServicePrice').value)||0;
  const status = document.getElementById('newServiceStatus').value;
  services.push({ id: Date.now(), name, price, status });
  renderServices();
  bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();
  document.getElementById('newServiceForm').reset();
}
function showEditService(id){
  const s = services.find(x=>x.id==id); if(!s) return;
  document.getElementById('editServiceId').value = s.id;
  document.getElementById('editServiceName').value = s.name;
  document.getElementById('editServicePrice').value = s.price;
  document.getElementById('editServiceStatus').value = s.status;
  new bootstrap.Modal(document.getElementById('editServiceModal')).show();
}
function updateService(e){
  e.preventDefault();
  const id = parseInt(document.getElementById('editServiceId').value);
  const name = document.getElementById('editServiceName').value;
  const price = parseFloat(document.getElementById('editServicePrice').value);
  const status = document.getElementById('editServiceStatus').value;
  const idx = services.findIndex(s=>s.id==id);
  if(idx>-1) services[idx] = { id, name, price, status };
  renderServices();
  bootstrap.Modal.getInstance(document.getElementById('editServiceModal')).hide();
}
function deleteService(id){
  if(confirm('Xóa dịch vụ này?')){
    services = services.filter(s=>s.id!==id);
    renderServices();
  }
}
function filterServices(){
  const q = document.getElementById('serviceSearch').value.toLowerCase();
  Array.from(document.querySelectorAll('#serviceTable tr')).forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

// ====== HISTORY ======
function renderHistoryTable(list=history){
  const tb = document.getElementById('historyTable'); tb.innerHTML='';
  list.forEach(h => {
    tb.innerHTML += `
      <tr>
        <td>${h.id}</td>
        <td>${h.date}</td>
        <td>${h.patientName}</td>
        <td>${h.doctorName}</td>
        <td>${h.roomName}</td>
        <td>${formatCurrency(h.totalAmount)}</td>
        <td><button class="btn btn-info btn-sm text-white" onclick="showHistoryDetails(${h.id})"><i class="fa-regular fa-eye"></i></button></td>
      </tr>`;
  });
}
function showHistoryDetails(id){
  const h = history.find(x=>x.id==id); if(!h) return;
  const detail = `
    Chi phí phòng: ${formatCurrency(h.details.roomCost)}
    Phí bác sĩ: ${formatCurrency(h.details.doctorFee)}
    Dịch vụ:
    ${(h.details.services||[]).map(s=>`- ${s.name} x ${s.quantity} (${formatCurrency(s.price)})`).join('\\n') || '- Không'}
  `;
  alert(detail);
}
function filterHistory(){
  const date = document.getElementById('historyDateFilter').value;
  const q = document.getElementById('historySearch').value.toLowerCase();
  const filtered = history.filter(h => (!date || h.date===date) && (!q || (h.patientName+h.id).toLowerCase().includes(q)));
  renderHistoryTable(filtered);
}

// ====== STATISTICS ======
function renderStatistics(){
  const patientsIn = rooms.filter(r=>r.status==='occupied').length;
  const doctorsOn = doctors.filter(d=>d.status==='on').length;
  const bedsFree = rooms.filter(r=>r.status==='free').length;
  const totalRevenue = history.reduce((s,h)=>s+h.totalAmount,0);
  document.getElementById('statPatientsIn').textContent = patientsIn;
  document.getElementById('statDoctorsOn').textContent = doctorsOn;
  document.getElementById('statBedsFree').textContent = bedsFree;
  document.getElementById('statRevenue').textContent = formatCurrency(totalRevenue);

  // monthly revenue (fake from history by month)
  const byMonth = {};
  history.forEach(h=>{
    const m = h.date.slice(0,7); // YYYY-MM
    byMonth[m] = (byMonth[m]||0) + h.totalAmount;
  });
  const chart = document.getElementById('monthlyRevenueChart');
  chart.innerHTML = '';
  const months = Object.keys(byMonth).sort();
  months.forEach(m=>{
    const max = Math.max(...Object.values(byMonth));
    const pct = max? Math.round(byMonth[m]/max*100):0;
    chart.innerHTML += `<div class="bar" style="height:${pct}%">
      <div class="value">${(byMonth[m]/1000).toFixed(0)}k</div>
      <div class="label">${m}</div>
    </div>`;
  });

  // revenue by room type
  const revType = { standard:0, vip:0 };
  history.forEach(h=>{
    const room = rooms.find(r=>`${r.room}/${r.bed}`===h.roomName);
    if(room){ revType[room.type] += h.details.roomCost; }
  });
  const total = revType.standard + revType.vip;
  const chart2 = document.getElementById('revenueByRoomType');
  chart2.innerHTML = `
    <div class="bar" style="height:${total?Math.round(revType.standard/total*100):0}%">
      <div class="value">${(revType.standard/1000).toFixed(0)}k</div>
      <div class="label">Thường</div>
    </div>
    <div class="bar" style="height:${total?Math.round(revType.vip/total*100):0}%">
      <div class="value">${(revType.vip/1000).toFixed(0)}k</div>
      <div class="label">VIP</div>
    </div>`;
}

// ====== INIT ======
document.addEventListener('DOMContentLoaded', () => {
  renderDashboardRooms();
  renderPatients();
  renderDoctors();
  renderRoomsTable();
  renderServices();
  renderHistoryTable();
  renderStatistics();

  document.getElementById('history-tab').addEventListener('click', renderHistoryTable);
  document.getElementById('stats-tab').addEventListener('click', renderStatistics);
});
</script>
</body>
</html>
